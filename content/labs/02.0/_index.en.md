---
title: "2.0 - Create a simple Chart"
weight: 20
---

In this lab we're going to create our very first Helm Chart and deploy it.

### Task 1

First let's create our chart:

```bash
$ helm create mychart
```

You'll now find a `mychart` directory with the newly created chart. It already is a valid and fully functional chart which deploys nginx. Have a look at the generated files and their content. For an explanation of the files, visit the [Helm Developer Documentation](https://docs.helm.sh/developing_charts/#the-chart-file-structure). In a later section you'll find all the information about Helm templates.


{{< collapse mobi "Mobi-specific instructions" danger >}}
You have to use the `docker-registry.mobicorp.ch/puzzle/k8s/kurs/nginx` container image instead of `nginx` which you cannot pull on your Kubernetes cluster.

Change your `values.yaml` to match the following:

```yaml
[...]
image:
  repository: docker-registry.mobicorp.ch/puzzle/k8s/kurs/nginx
  tag: stable
  pullPolicy: IfNotPresent
[...]
```
{{< /collapse >}}

### Task 2

Before actually deploying our generated chart, we can check the (to be) generated Kubernetes resources with the following command:

{{< tabs >}}{{< tab-md "Helm 2" >}}
```bash
$ helm install --dry-run --debug --namespace [USER] --tiller-namespace [USER] ./mychart
```
{{< /tab-md >}}{{< tab-md "Helm 3" >}}
```bash
$ helm install --dry-run --debug --namespace [USER] myfirstrelease ./mychart
```
{{< /tab-md >}}{{</ tabs >}}

Finally, the following command creates a new Release with the Helm Chart and deploys the application:

{{< tabs >}}{{< tab-md "Helm 2" >}}
```bash
$ helm install --name myfirstrelease --namespace [USER] --tiller-namespace [USER] ./mychart 
```
{{< /tab-md >}}{{< tab-md "Helm 3" >}}
```bash
$ helm install --namespace [USER] myfirstrelease ./mychart
```
{{< /tab-md >}}{{</ tabs >}}

The `--name` parameter allows you to give your Release a name, it is not mandatory though, the name will be autogenerated if no explicit name is provided.

With `kubectl get pods --namespace [USER]` you should see a new pod. You can list the newly created Helm release with the following command:

{{< tabs >}}{{< tab-md "Helm 2" >}}
```bash
$ helm ls --namespace [USER] --tiller-namespace [USER]
```
{{< /tab-md >}}{{< tab-md "Helm 3" >}}
```bash
$ helm ls --namespace [USER]
```
{{< /tab-md >}}{{</ tabs >}}

{{< notice tip >}}
**Helm 2:** You can omit the parameter `--tiller-namespace [USER]` if you set the following environment variable: `export TILLER_NAMESPACE=[USER]`
{{< /notice >}}

### Task 3

Our freshly deployed nginx is not yet accessible from outside of the Kubernetes cluster. To expose it, we have to change the service type to `NodePort`.
Search now for the Service type definition in your Chart and make the change.

{{< collapse solution-servicetype "Solution" success >}}
A look into the file `templates/service.yaml` reveals that the service type is set by value:
```yaml
[...]
spec:
  type: {{ .Values.service.type }}
[...]
```

Thus we need to change this value inside our `values.yaml` file:
```yaml
[...]
service:
  type: NodePort
  port: 80
[...]
```
{{< /collapse >}}

Apply the change by upgrading our release:

{{< tabs >}}{{< tab-md "Helm 2" >}}
```bash
$ helm upgrade myfirstrelease --namespace [USER] --tiller-namespace [USER] ./mychart
```
{{< /tab-md >}}{{< tab-md "Helm 3" >}}
```bash
$ helm upgrade --namespace [USER] myfirstrelease ./mychart 
```
{{< /tab-md >}}{{</ tabs >}}

As soon as the service has a NodePort you will see in the output of the following command (as we use `--watch` you have to terminate the command with CTRL-C):

```bash
$ kubectl get svc --namespace [USER] --watch
```

nginx is now available at the given NodePort and should display a welcome page when accessing it with `curl` or your browser of choice.

{{< notice tip >}}
Use `kubectl get node -o wide` to get a node ip address. Remember, [NodePort's](https://kubernetes.io/docs/concepts/services-networking/service/#nodeport) are open on any kubernetes node
{{< /notice >}}

{{< collapse mobi "Mobi-specific instructions" danger>}}
In case you don't have permissions to list the nodes with `kubectl get node -o wide` simply use `kubedev-worker-00bb7020c0eb.phoenix.mobicorp.test` as the node address to access the welcome page.
{{< /collapse >}}

### Task 4

An alternative way to set or overwrite values for charts we want to deploy is the `--set name=value` parameter. `--set name=value` can be used when installing a Chart as well as upgrading.

Update the replica count of your nginx Deployment to 2 using `--set name=value`

{{< collapse solution-replicacount "Solution" success >}}

**Helm 2:**
```bash
$ helm upgrade myfirstrelease --set replicaCount=2 --namespace [USER] --tiller-namespace [USER] mychart
```

**Helm 3:**
```bash
$ helm upgrade --namespace [USER] --set replicaCount=2 myfirstrelease mychart 
```

Values that have been set using `--set` can be reset by helm upgrade with `--reset-values`.
{{< /collapse >}}

### Task 5

To remove an application, simply remove the Helm Release with the following command:

{{< tabs >}}{{< tab-md "Helm 2" >}}
```bash
$ helm delete myfirstrelease --tiller-namespace [USER]
```
{{< /tab-md >}}{{< tab-md "Helm 3" >}}
```bash
$ helm delete myfirstrelease
```
{{< /tab-md >}}{{</ tabs >}}

Do this with our deployed release. With `kubectl get pods --namespace [USER]` you should no longer see your application pod.
